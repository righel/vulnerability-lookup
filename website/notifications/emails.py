#! /usr/bin/env python3

from typing import Any

import logging
import os
import smtplib
from datetime import datetime, timezone
from email import charset
from email.mime.nonmultipart import MIMENonMultipart

from website.web.bootstrap import application


logger = logging.getLogger(__name__)


def send(*args: str, **kwargs: Any) -> None:
    """
    This functions enables to send email (via different method).
    """
    if application.debug:
        write_email(**kwargs)
    else:
        send_smtp(**kwargs)


def write_email(
    to: str = "", subject: str = "", plaintext: str = "", html: str = ""
) -> None:
    filename = "sent-emails/{}.txt".format(
        datetime.now(timezone.utc).strftime("%Y%m%dT%H%M%S")
    )
    os.makedirs(os.path.dirname(filename), exist_ok=True)
    content = plaintext
    with open(filename, "w") as f:
        f.write(content)


def send_smtp(
    to: str = "", subject: str = "", plaintext: str = "", html: str = ""
) -> None:
    """
    Send an email.
    """
    # Create message container
    msg = MIMENonMultipart("text", "plain", charset="utf-8")
    # Construct a new charset which uses Quoted Printables (base64 is default)
    cs = charset.Charset("utf-8")
    cs.body_encoding = charset.QP
    msg["Subject"] = subject
    msg["From"] = application.config["MAIL_DEFAULT_SENDER"]
    msg["To"] = to

    msg.set_payload(plaintext, charset=cs)

    try:
        s = smtplib.SMTP(application.config["MAIL_SERVER"])
        if application.config["MAIL_USERNAME"] is not None:
            s.login(
                application.config["MAIL_USERNAME"],
                application.config["MAIL_PASSWORD"],
            )
    except ConnectionRefusedError:
        print("Problem when sending email.")
    except Exception:
        logger.exception("send_smtp raised:")
    else:
        try:
            s.sendmail(
                application.config["MAIL_DEFAULT_SENDER"],
                msg["To"],
                msg.as_bytes().decode(encoding="UTF-8"),
            )
            s.quit()
        except Exception:
            pass
