#! /usr/bin/env python3

import datetime
from datetime import timezone

from flask import render_template

from website.models import User
from website.web.bootstrap import application
from website.lib.user_utils import generate_confirmation_token
from website.notifications import emails


def account_recovery(user: User) -> None:
    """Account recovery."""
    token = generate_confirmation_token(user.login)
    expire_time = datetime.datetime.now(timezone.utc) + datetime.timedelta(
        seconds=application.config["TOKEN_VALIDITY_PERIOD"]
    )

    plaintext = render_template(
        "emails/account_recovery.txt",
        user=user,
        platform_url=application.config["PLATFORM_URL"],
        token=token,
        expire_time=expire_time,
    )

    emails.send(
        to=user.email,
        subject="[Vulnerability-Lookup] Account recovery",
        plaintext=plaintext,
    )


def new_password_notification(user: User, password: str) -> None:
    """
    New password notification.
    """
    plaintext = render_template("emails/new_password.txt", user=user, password=password)
    emails.send(
        to=user.email,
        subject="[Vulnerability-Lookup] New password",
        plaintext=plaintext,
    )


def confirm_account(user: User) -> None:
    """
    Account creation notification.
    """
    token = generate_confirmation_token(user.login)
    expire_time = datetime.datetime.now(timezone.utc) + datetime.timedelta(
        seconds=application.config["TOKEN_VALIDITY_PERIOD"]
    )

    plaintext = render_template(
        "emails/account_activation.txt",
        user=user,
        platform_url=application.config["PLATFORM_URL"],
        token=token,
        expire_time=expire_time,
    )

    emails.send(
        to=user.email,
        subject="[Vulnerability-Lookup] Account creation",
        plaintext=plaintext,
    )


def new_comment_to_moderate(user: User) -> None:
    """
    Notify the admin when a comment is awaiting moderation.
    """
    plaintext = render_template(
        "emails/comment_moderation.txt",
        user=user,
        platform_url=application.config["PLATFORM_URL"],
    )

    emails.send(
        to=application.config.get("ADMIN_EMAIL", ""),
        subject="[Vulnerability-Lookup] New comment awaiting moderation",
        plaintext=plaintext,
    )
