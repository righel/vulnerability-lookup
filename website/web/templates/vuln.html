{% extends "main.html" %}
{% import 'vulnerability_templates.html' as vuln_templates with context %}
{% import 'comment_templates.html' as comment_templates %}

{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/showdown.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/lodash.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/luxon.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jsoneditor.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/pretty-print-json.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/easymde.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/plots.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/easymde.min.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/pretty-print-json.css') }}" />
<style>
  /* Optional styling to indicate clickable header */
  th {
    cursor: pointer;
  }
  .chevron {
      font-size: 18px;
      color: #446d80; /* Change to the color you want */
  }

  /* Style to make the chart scrollable horizontally */
  .chart-container {
    position: relative; /* Required for positioning */
    width: 100%; /* Make it responsive */
    height: 400px; /* Set a specific height for the chart */
    overflow-x: auto; /* Enable horizontal scroll */
  }
  canvas {
    width: 100% !important; /* Make the canvas take full width */
    height: auto !important; /* Allow the height to adjust automatically */
  }
</style>
{% endblock %}

{% block title %}{{source}} - {{vulnerability_id}}{% endblock %}

{% block content %}

<div class="modal" id="modalError" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Action not permitted</h5>
      </div>
      <div class="modal-body">
        <p id="modal-error-text">Modal body text goes here.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


{% if source ==  'nvd' %}
{{vuln_templates.nvd_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'cvelistv5' %}
{{vuln_templates.cvelistv5_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'circl' or source == local_instance_name %}
{{vuln_templates.circl_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data, current_user=current_user)}}
{% elif source ==  'github' %}
{{vuln_templates.github_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'gsd' %}
{{vuln_templates.gsd_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'pysec' %}
{{vuln_templates.pysec_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'ossf_malicious_packages' %}
{{vuln_templates.ossf_malicious_packages_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_certbund' %}
{{vuln_templates.csaf_certbund_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_siemens' %}
{{vuln_templates.csaf_siemens_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_redhat' %}
{{vuln_templates.csaf_redhat_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_cisa' %}
{{vuln_templates.csaf_cisa_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source == 'csaf_cisco' %}
{{vuln_templates.csaf_cisco_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source == 'csaf_sick' %}
{{vuln_templates.csaf_sick_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source == 'csaf_ox' %}
{{vuln_templates.csaf_ox_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source == 'csaf_nozominetworks' %}
{{vuln_templates.csaf_nozominetworks_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source == 'variot' %}
{{vuln_templates.variot_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source == 'jvndb' %}
{{vuln_templates.jvndb_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source == 'tailscale' %}
{{vuln_templates.tailscale_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{%elif source %}
Other source: {{source}}.
<pre>{{vulnerability_data|tojson(indent=2)}}</pre>
{% endif %}

{% if vulnerability_data == {} %}
{{ vuln_templates.unpublished(vulnerability_id=vulnerability_id) }}
{% endif %}

<br />
<ul class="nav nav-tabs" id="pageTab" role="tablist">
  <li class="nav-item">
    <button class="nav-link active" id="related-tab" data-bs-toggle="tab" data-bs-target="#related" role="tab" aria-controls="related" aria-selected="true" href="#related">Related vulnerabilities <span class="badge bg-primary rounded-pill">{{ nb_linked_vulns }}</span></button>
  </li>
  {% if config.user_accounts  %}
  <li class="nav-item">
    <button class="nav-link" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments" role="tab" aria-controls="comments" aria-selected="false" onclick="loadComments()" href="#comments">Comments <span class="badge bg-primary rounded-pill" id="nb-comments">{{ nb_comments }}</span></button>
  </li>
  <li class="nav-item">
    <button class="nav-link" id="bundles-tab" data-bs-toggle="tab" data-bs-target="#bundles" role="tab" aria-controls="bundles" aria-selected="false" onclick="loadBundles()" href="#bundles">Bundles <span class="badge bg-primary rounded-pill" id="nb-bundles">{{ nb_bundles }}</span></button>
  </li>
  <li class="nav-item">
    <button class="nav-link" id="sightings-tab" data-bs-toggle="tab" data-bs-target="#sightings" role="tab" aria-controls="sightings" aria-selected="false" onclick="loadSightings()" href="#sightings">Sightings <span class="badge bg-primary rounded-pill" id="nb-sightings">{{ nb_sightings }}</span></button>
  </li>
  {% endif %}
</ul>
<div class="tab-content" id="pageTabContent">
  <div class="tab-pane fade show active" id="related" role="tabpanel" aria-labelledby="related-tab">
    <br />
    <div class="row">
      <div class="col text-end">
        <a class="icon-link" href="{{ url_for('home_bp.feed_recent', vulnerability=vulnerability_id, format='atom', source='all') }}" type="application/atom+xml" title="Atom feed">{{ render_icon('rss') }}</a>
        <a class="icon-link" href="{{ url_for('home_bp.feed_recent', vulnerability=vulnerability_id, format='rss', source='all') }}" type="application/atom+xml" title="RSS feed">{{ render_icon('rss-fill') }}</a>
    </div>
  </div>
  {% if linked_vulns %}
    {% for source, vulnerabilities in linked_vulns.items() %}
      {% for vuln_id, vulnerability_data in vulnerabilities %}
        {% if source ==  'nvd' %}
        {{vuln_templates.nvd_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'cvelistv5' %}
        {{vuln_templates.cvelistv5_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'circl' %}
        {{vuln_templates.circl_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data, current_user=current_user)}}
        {% elif source ==  'github' %}
        {{vuln_templates.github_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'gsd' %}
        {{vuln_templates.gsd_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'pysec' %}
        {{vuln_templates.pysec_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'ossf_malicious_packages' %}
        {{vuln_templates.ossf_malicious_packages_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_certbund' %}
        {{vuln_templates.csaf_certbund_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_siemens' %}
        {{vuln_templates.csaf_siemens_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_redhat' %}
        {{vuln_templates.csaf_redhat_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_cisa' %}
        {{vuln_templates.csaf_cisa_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_cisco' %}
        {{vuln_templates.csaf_cisco_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_sick' %}
        {{vuln_templates.csaf_sick_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_ox' %}
        {{vuln_templates.csaf_ox_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_nozominetworks' %}
        {{vuln_templates.csaf_nozominetworks_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'variot' %}
        {{vuln_templates.variot_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source == 'jvndb' %}
        {{vuln_templates.jvndb_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source == 'tailscale' %}
        {{vuln_templates.tailscale_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {%elif source %}
        Other source: {{source}}.
        <pre>{{vulnerability_data|tojson(indent=2)}}</pre>
        {% endif %}
        <br />
      {% endfor%}
    {% endfor%}
  {% endif %}
  </div>
  {% if config.user_accounts  %}
  <div class="tab-pane fade show" id="comments" role="tabpanel" aria-labelledby="comments-tab">
    <br />

    <div class="row">
      <div class="col">
        {% if config.user_accounts and current_user.is_authenticated %}
        <button id="buttonNewComment" class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#newComment{{vulnerability_id}}" aria-expanded="false" aria-controls="newComment{{vulnerability_id}}">
          New comment{{ render_icon('chevron-down') }}
        </button>
        {% elif config.user_accounts %}
        <p><a href="{{ url_for('user_bp.login') }}">Log in</a> or <a href="{{ url_for('user_bp.signup') }}">create an account</a> to share your comment.</p>
        {% endif %}
      </div>
      {% if config.user_accounts  %}
      <div class="col text-end">
          <a class="icon-link" href="{{ url_for('comments_bp.feed_comments', vulnerability=vulnerability_id, format='atom') }}" type="application/atom+xml" title="Atom feed">{{ render_icon('rss') }}</a>
          <a class="icon-link" href="{{ url_for('comments_bp.feed_comments', vulnerability=vulnerability_id, format='rss') }}" type="application/atom+xml" title="RSS feed">{{ render_icon('rss-fill') }}</a>
      </div>
      {% endif %}
    </div>
    <div class="collapse" id="newComment{{vulnerability_id}}">
      <div class="row">
        <div class="col-md-9">
          <div id="editor"></div>
        </div>
        <div class="col">
          <br /><br /><br />
          <div class="card card-body my-3">
            <h5>Tags</h5>
            <select class="form-multi-select" id="select-tags" size="9" multiple>
              <optgroup label="Exploitability" exclusive="true">
                <option value="vulnerability:exploitability=industrialised">Industrialised</option>
                <option value="vulnerability:exploitability=customised">Customised</option>
                <option value="vulnerability:exploitability=documented">Documented</option>
                <option value="vulnerability:exploitability=theoretical">Theoretical</option>
              </optgroup>
              <optgroup label="Information" exclusive="false">
                <option value="vulnerability:information=PoC">Proof-of-Concept</option>
                <option value="vulnerability:information=remediation">Remediation</option>
                <option value="vulnerability:information=annotation">Annotation</option>
              </optgroup>
            </select>
            <a href="https://www.misp-project.org/taxonomies.html#_vulnerability_3" rel="noreferrer" target="_blank">Taxonomy of the tags.</a>
          </div>
          <button class='btn btn-primary' id='savecomment' title="Save the comment">Save the comment</button>
        </div>
      </div>
    </div>
    <br /><br />
    <div id="list-comments">
      <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
      </div>
    </div>
  </div>

  <div class="tab-pane fade show" id="bundles" role="tabpanel" aria-labelledby="bundles-tab">
    <br />
    <div id="list-bundles">
      <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
      </div>
    </div>
  </div>

  <div class="tab-pane fade show" id="sightings" role="tabpanel" aria-labelledby="sightings-tab">
    <br />
    <div class="row pb-3" id="sightings-pane-top">
      <div class="col">
        <a class="btn btn-primary" href="{{ url_for('sightings_bp.list_sightings', query=vulnerability_id) }}">All sightings related to this event</a>
        <a class="btn btn-primary" href="{{ url_for('sightings_bp.export_sightings_vuln', vulnerability=vulnerability_id) }}">Export sightings related to this event</a>
      </div>
    </div>
    <div id="chart-sightings">
      <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
      </div>
    </div>
    <div id="sightingsChartContainer" class="chart-container pt-3">
      <canvas id="sightingsChart" height="400"></canvas>
    </div>
    <div id="chart-detailed-legend" class="row">
      <div class="col-md-8">
        <ul class="list-group list-group-flush">
          <li class="list-group-item"><b>Seen</b>: The vulnerability was mentioned, discussed, or seen somewhere by the user.</li>
          <li class="list-group-item"><b>Confirmed</b>: The vulnerability is confirmed from an analyst perspective.</li>
          <li class="list-group-item"><b>Exploited</b>: This vulnerability was exploited and seen by the user reporting the sighting.</li>
          <li class="list-group-item"><b>Patched</b>: This vulnerability was successfully patched by the user reporting the sighting.</li>
          <li class="list-group-item"><b>Not exploited</b>: This vulnerability was not exploited or seen by the user reporting the sighting.</li>
          <li class="list-group-item"><b>Not confirmed</b>: The user expresses doubt about the veracity of the vulnerability.</li>
          <li class="list-group-item"><b>Not patched</b>: This vulnerability was not successfully patched by the user reporting the sighting.</li>
        </ul>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% if config.user_accounts  %}
<script>
  let easyMDE = null;
  let SCHEMA = null;
  let COMMENTS = {};

  function openTabById(tabId) {
    const tabButton = document.querySelector(`button[data-bs-target="${tabId}"]`);
    if (tabButton) {
      const tab = new bootstrap.Tab(tabButton);
      tab.show();
    } else {
      console.error(`Tab with ID ${tabId} not found.`);
    }
  }

  function getSelectValues(select) {
    var tags = [];
    var options = select && select.options;
    var opt;

    for (var i=0, iLen=options.length; i<iLen; i++) {
      opt = options[i];

      if (opt.selected) {
        if (opt.parentNode.getAttribute("exclusive") == "true") {
          options1 = document.getElementById("select-tags").options;
          for (var j=0, jLen=options1.length; j<jLen; j++) {
            opt1 = options1[j];
            if (opt1.parentNode.getAttribute("exclusive") == "true") {
              opt1.selected = false;
            }
          }
          opt.selected = true;
        }
        tags.push(opt.value || opt.text);
      }
    }
    var json = jsoneditor.getValue();

    if (!("meta" in json)) {
      json["meta"] = [{"tags": tags}];
    } else {
      json["meta"].forEach(function(value, index, array) {
      if ("tags" in value) {
        obj = {"tags": tags}
        json["meta"] = [];
        json["meta"] = [obj];
      }
    })
    }

    jsoneditor.setValue(json);
  }

  document.getElementById("select-tags").onclick= function (e) {
    getSelectValues(document.getElementById("select-tags"));
  };

  function addNumberSuffix(num) {
    const remainder10 = num % 10;
    const remainder100 = num % 100;

    if (remainder10 === 1 && remainder100 !== 11) {
        return num + "st";
    } else if (remainder10 === 2 && remainder100 !== 12) {
        return num + "nd";
    } else if (remainder10 === 3 && remainder100 !== 13) {
        return num + "rd";
    } else {
        return num + "th";
    }
  }

  function formatNumberWithPrecision(value, precision) {
    const formattedValue = parseFloat(value.toFixed(precision));
    return formattedValue;
  }

  function RoundNumber(value) {
    return Math.round(value);
  }


  document.addEventListener("DOMContentLoaded", function() {
    // Enable tootips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    var jsonContainers = document.querySelectorAll(".json-container");
    Array.prototype.forEach.call(jsonContainers, function(jsonContainer) {
      jsonContainer.innerHTML = prettyPrintJson.toHtml(JSON.parse(jsonContainer.innerText));
    });

    fetch("{{ url_for('static', filename='schemas/CIRCL/Security_Advisory_Comment.json') }}")
    .then(response => response.json())
    .then(result => {
      // initialize the JSON editor
      SCHEMA = result;
      initialize_editor(SCHEMA, {});
    }).catch((error) => {
      console.error('Error:', error);
    });


    // Retrieve the EPSS score
    epss_score_elem = document.getElementById("epss-score");
    if (epss_score_elem) {
      fetch("{{ url_for('apiv1.epss_epss_item', vulnerability_id=vulnerability_id) }}")
      .then(response => response.json())
      .then(result => {
        if (result.total >= 1) {
          document.getElementById("epss-score").parentNode.parentNode.removeAttribute("hidden");
          document.getElementById("epss-score").innerText = (result.data[0].epss * 100).toFixed(2) + "%";
          document.getElementById("epss-percentile").innerText = "(" + formatNumberWithPrecision(Number(result.data[0].percentile), 5) + ")";
        } else {
          document.getElementById("epss-score").parentNode.parentNode.remove();
        }
      }).catch((error) => {
        console.error('Error:', error);
        document.getElementById("epss-score").parentNode.parentNode.remove();
      });
    }
  })


  // Open the tab specified with an anchor in the URL.
  window.onload = function() {
    const hash = window.location.hash;
    const tabButton = document.querySelector(`button[data-bs-target="${hash}"]`);
    if (tabButton) {
      const tab = new bootstrap.Tab(tabButton);
      tab.show();
      selected_tab = tabButton.getAttribute("id");
      switch (selected_tab) {
        case "comments-tab":
          loadComments();
          break;
        case "bundles-tab":
          loadBundles();
          break;
        case "sightings-tab":
          loadSightings();
          break;
        default:
          console.log("Not a valid day.");
      }
    }
    // Update the URL when a tab is clicked, for consistent behavior
    document.querySelectorAll('.nav-link[data-bs-toggle="tab"]').forEach(tabLink => {
      tabLink.addEventListener("shown.bs.tab", function(event) {
        history.replaceState(null, null, event.target.getAttribute("href"));
      });
    });
  };


  if (document.getElementById("deleteVulnerability")) {
    document.getElementById("deleteVulnerability").onclick = function(event) {
    if (!confirm('You are going to delete the vulnerability. Are you sure?')) {
        return;
    }
    var csrf_token = "{{ csrf_token() }}";
    fetch("{{ url_for('apiv1.default_vulnerability', vulnerability_id=vulnerability_id) }}", {
      method: "DELETE",
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf_token
          }
    })
    .then(response => {
      if (!response.ok) {
        console.log(response);
      } else {
        window.location="{{ url_for('home_bp.recent') }}";
      }
    })
    .catch((error) => {
      console.log(error);
    });
  };
  }

  function addSighting(originalEvent) {
    const clickedItem = originalEvent.target;
    var csrf_token = "{{ csrf_token() }}";
    var json = {};
    json["type"] = clickedItem.getAttribute("value");
    json["vulnerability"] = "{{ vulnerability_id }}";
    data = JSON.stringify(json);
    fetch("{{ url_for('apiv1.sighting_sightings_list') }}", {
      method: "POST",
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrf_token
      },
      body: data
    })
    .then(res => {
      if (!res.ok) {
        res.json().then(json => {
          document.getElementById("modal-error-text").innerText = "Problem when saving sighting.";
          var modal = new bootstrap.Modal(document.getElementById('modalError'), {});
          modal.show();
        });
      } else {
        loadSightings();
        showToast("Success", "Sighting added successfully!");
        openTabById("#sightings");

      }
    })
    .catch((error) => {
      console.log(error);
    });
  };

  sightings_list = document.getElementById("sighting-list");
  if (sightings_list) {
    document.getElementById("sighting-list").addEventListener("click", function(event) {
      showModal('New sighting', "Are you sure you want to add this sighting?", addSighting, event);
    });
  }

  document.getElementById("savecomment").addEventListener("click", function(event) {
    var csrf_token = "{{ csrf_token() }}";
    var json = jsoneditor.getValue();
    json["description"] = easyMDE.value();
    json["vulnerability"] = "{{ vulnerability_id }}";
    data = JSON.stringify(json);
    fetch("{{ url_for('apiv1.comment_comments_list') }}", {
      method: "POST",
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrf_token
      },
      body: data
    })
    .then(res => {
      if (!res.ok) {
        res.json().then(json => {
          document.getElementById("modal-error-text").innerText = json['message'];
          var modal = new bootstrap.Modal(document.getElementById('modalError'), {});
          modal.show();
        });
      } else {
        // reinitializes the form
        window.jsoneditor.setValue({});
        easyMDE.value("");
        // collapse the view which is containing the form
        new bootstrap.Collapse(document.getElementById("newComment{{vulnerability_id}}"));
        // load the updated list of comments
        loadComments();
        showToast("Success", "Comment added successfully!");
      }
    })
    .catch((error) => {
      console.log(error);
    });
  });

  function copyToClipboard(vuln_id) {
    const copyText = document.getElementById("container"+vuln_id).textContent;
    const textArea = document.createElement('textarea');
    textArea.textContent = copyText;
    navigator.clipboard.writeText(textArea.value).then(function() {
      /* clipboard successfully set */
      showToast("Success", "Content copied to your clipboard.");
    }, function() {
      /* clipboard write failed */
    });
  }

  function loadComments() {
    COMMENTS = {};
    if (easyMDE  === null) {
      easyMDE = new EasyMDE({
            element: document.getElementById('root[description]'),
            autoRefresh: { delay: 300 },
            toolbarButtonClassPrefix: "mde",
            toolbar: [
              "bold", "italic", "heading", "|", "quote", "code", "table", "unordered-list", "ordered-list", "|", "link", "image", "|", "preview", "side-by-side", "fullscreen", "|"
            ]
          });
    }
    var DateTime = luxon.DateTime;
    var converter = new showdown.Converter({tables: true, moreStyling: true});
    var commentTemplate = _.template(
      '<div class="card markdown-description">' +
      '<div class="card-body">' +
        '<h5 class="card-title"><a href="/comment/<%= uuid %>"><%= title %></a></h5>' +
        '<p class="card-title">' +
        '<% _.forEach(tags, function(tag) ' +
              '{ %><span class="badge bg-primary"><a class="link-light" href="/comments/?meta=%5B%7B%22tags%22%3A%20%5B%22<%= tag %>%22%5D%7D%5D"><%= tag %></a></span> <% }); %>' +
        '</p>' +
        '<h6 class="card-subtitle mb-2 text-body-secondary"><%= timestamp %> by <a href="/user/<%= author_login %>"><%= author_name %></a></h6>' +
        '<p class="card-text"><%= description %></p>' +
        '<div class="btn-group" role="group">' +
          '<a role="button" class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#collapseJsonComment<%= uuid %>" aria-expanded="false" aria-controls="collapseJsonComment<%= uuid %>">JSON</a>' +
        '</div>' +
        '<div class="collapse" id="collapseJsonComment<%= uuid %>"><br /><pre class="json-container"><%= comment %></pre></div>' +
      '</div></div>'
    );
    fetch("{{ url_for('apiv1.comment_comments_list', vuln_id=vulnerability_id) }}")
    .then(response => response.json())
    .then(result => {
      document.getElementById("list-comments").innerHTML = "";
      document.getElementById("nb-comments").innerText = result.metadata.count;
      if (result.metadata.count == 0) {
        document.getElementById("list-comments").innerHTML = "<p>No comment for this vulnerability. Browse <a href='/comments'>all the comments</a>.</p>";
      }
      result.data
      .sort(function (a, b) {
        return new Date(b.timestamp) - new Date(a.timestamp);
      })
      .map(function (comment) {
        var author = comment.author
        delete comment.author;
        if (Array.isArray(comment["meta"]) && comment["meta"].length > 0) {
          var itemWithTags = comment.meta.find(item => item.tags);
          var tags = itemWithTags ? itemWithTags.tags : [];
        } else {
          var tags = [];
        }
        var cardHTML = commentTemplate({
          'comment': JSON.stringify(comment, null, 2),
          'uuid': comment.uuid,
          'title': comment.title,
          'description': converter.makeHtml(comment.description),
          'timestamp': DateTime.fromISO(comment.timestamp).toRelative(),
          'author_name': author.name,
          'author_login': author.login,
          'tags': tags
        });
        COMMENTS[comment.uuid] = comment;
        var element = document.createElement("div");
        var element_br = document.createElement("br");
        element.innerHTML = cardHTML;
        document.getElementById("list-comments").appendChild(element.firstChild);
        document.getElementById("list-comments").append(element_br);
      })
    })
    .then(_ => {
      setTimeout(() => {
        formatMarkdownOutput();
      }, 0);  // 0ms delay still allows the browser to update the DOM
      return COMMENTS;
    })
    .catch((error) => {
      console.error('Error:', error);
    });


  }

  function initialize_editor(schema, json_object) {
    // Default starting schema
    if(!schema) {
      schema = {}
    }

    // Divs/textareas on the page
    var $schema = schema;
    var $output = document.getElementById('output');
    var $editor = document.getElementById('editor');

    // Default theme
    JSONEditor.defaults.options.theme = 'bootstrap5';

    window.startval = json_object;

    var jsoneditor;

    var reload = function(keep_value) {
      var startval = (jsoneditor && keep_value)? jsoneditor.getValue() : window.startval;
      window.startval = undefined;

      if (jsoneditor) {
        jsoneditor.destroy();
      }
      jsoneditor = new JSONEditor($editor, {
        // The schema for the editor
        schema: schema,
        // Remove collapse button
        disable_collapse: true,
        // Seed the form with a starting value
        startval: startval,
        // Enable fetching schemas via ajax
        ajax: true,
        // Disable additional properties
        no_additional_properties: false,
        // Require all properties by default
        required_by_default: true,
        show_opt_in: false,
        disable_edit_json: true,
        theme: "bootstrap5",
        object_background: document.documentElement.getAttribute("data-bs-theme") == "dark" ? "bg-dark" : "bg-light",
      });
      window.jsoneditor = jsoneditor;

      // When the value of the editor changes, update the JSON output and validation message
      jsoneditor.on('change',function() {
        var json = jsoneditor.getValue();
      });
    };
    // Start the schema and output textareas with initial values
    $schema.value = JSON.stringify(schema, null, 2);
    reload();
  };

  function loadBundles() {
    var DateTime = luxon.DateTime;
    var converter = new showdown.Converter({tables: true, moreStyling: true});
    var bundleTemplate = _.template(
        '<div class="card markdown-description">' +
        '<div class="card-body">' +
        '<h5 class="card-title"><a href="/bundle/<%= uuid %>"><%= name %></a></h5>' +
        '<h6 class="card-subtitle mb-2 text-body-secondary"><%= timestamp %> by <a href="/user/<%= author_login %>"><%= author_name %></a></h6>' +
        '<p class="card-text"><%= description %></p>' +
        '<h5 class="card-text">Related vulnerabilities</h5>' +
        '<div class="card" >' +
        '<ul class="list-group list-group-flush">' +
        '<% _.forEach(related_vulnerabilities, function(vuln) ' +
            '{ %><li class="list-group-item"><a href="/vuln/<%= vuln %>"><%- vuln %></a></li><% }); %>' +
        '</ul>' +
        '</div>' +
        '</div>');
    fetch("{{ url_for('apiv1.bundle_bundles_list', vuln_id=vulnerability_id) }}")
    .then(response => response.json())
    .then(result => {
    document.getElementById("list-bundles").innerHTML = "<p>Bundles referring to this vulnerability.</p>";
    if (result.metadata.count == 0) {
        document.getElementById("list-bundles").innerHTML = "<p>This vulnerability is not linked to any bundle.</p>";
    }
    result.data
    .sort(function (a, b) {
        return new Date(b.updated_at) - new Date(a.updated_at);
    })
    .map(function (bundle) {
        var author = bundle.author
        delete bundle.author;
        var cardHTML = bundleTemplate({
        'uuid': bundle.uuid,
        'name': bundle.name,
        'description': converter.makeHtml(bundle.description),
        'timestamp': DateTime.fromISO(bundle.timestamp).toRelative(),
        'related_vulnerabilities': bundle.related_vulnerabilities.map(v => v.toLowerCase()),
        'author_name': author.name,
        'author_login': author.login
        });
        var element = document.createElement("div");
        var element_br = document.createElement("br");
        element.innerHTML = cardHTML;
        document.getElementById("list-bundles").appendChild(element.firstChild);
        document.getElementById("list-bundles").append(element_br);
    })
    })
    .then(_ => {
      setTimeout(() => {
        formatMarkdownOutput();
      }, 0);  // 0ms delay still allows the browser to update the DOM
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  };


  function loadSightings() {
    fetch("{{ url_for('apiv1.sighting_sightings_list', vuln_id=vulnerability_id) }}")
    .then(response => response.json())
    .then(result => {
      document.getElementById("nb-sightings").innerText = result.metadata.count;
      if (result.metadata.count == 0) {
          document.getElementById("sightings-pane-top").style.display = 'none';
          document.getElementById("chart-sightings").innerHTML = "<p>No sightings for this vulnerability.</p>";
          document.getElementById("sightingsChartContainer").style.display = 'none';
          document.getElementById("chart-detailed-legend").style.display = 'none';
      } else{
        drawBarChart(result.data);
        document.getElementById("sightings-pane-top").style.display = 'block';
        document.getElementById("chart-sightings").innerHTML = "<h3>Evolution of sightings over time.</h3>";
        document.getElementById("sightingsChartContainer").style.display = 'block';
        document.getElementById("chart-detailed-legend").style.display = 'block';
      }
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  };

document.getElementById("btnThemeSwitch").addEventListener("click",()=>{
    if (document.documentElement.getAttribute("data-bs-theme") == "dark") {
      Array.from(document.getElementsByClassName("card")).forEach(container => {
        container.classList.remove("bg-dark");
        container.classList.add("bg-light");
      });
    } else {
      Array.from(document.getElementsByClassName("card")).forEach(container => {
        container.classList.remove("bg-light");
        container.classList.add("bg-dark");
      });
    }
  })
</script>
{% endif %}
{% endblock %}
