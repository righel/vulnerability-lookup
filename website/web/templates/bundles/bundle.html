{% extends "main.html" %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/pretty-print-json.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/luxon.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/utils.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/pretty-print-json.css') }}" />
{% endblock %}
{% block title %}Bundle - {{ bundle.name }}{% endblock %}
{% block content %}
<div class="row">
  <div class="col">
    <h1><a href="{{ url_for('bundle_bp.get', bundle_uuid=bundle.uuid) }}">{{ bundle.name }}</a></h1>
  </div>
  <div class="col text-end">
    <div class="btn-group" role="group">
      <div class="btn-group" role="group">
        <button id="btnGroupDropShare" type="button" class="btn btn-primary" data-bs-toggle="dropdown" aria-expanded="false">
          {{ render_icon('share') }}
        </button>
        <ul class="dropdown-menu" aria-labelledby="btnGroupDropShare">
          <li><a class="dropdown-item" href="https://news.ycombinator.com/submitlink?u=https://{{ config.PUBLIC_DOMAIN }}{{ url_for('bundle_bp.get', bundle_uuid=bundle.uuid) }}&t={{ bundle.name }}" target="_blank" title="Share on Hacker News">Hacker News</a></li>
          <li><a class="dropdown-item" href="https://www.linkedin.com/shareArticle?mini=true&url=https://{{ config.PUBLIC_DOMAIN }}{{ url_for('bundle_bp.get', bundle_uuid=bundle.uuid) }}&title={{ bundle.name }}" target="_blank" title="Share on LinkedIn">LinkedIn</a></li>
          <li><a class="dropdown-item" href="https://mastodonshare.com/?text={{ bundle.name }}&url=https://{{ config.PUBLIC_DOMAIN }}{{ url_for('bundle_bp.get', bundle_uuid=bundle.uuid) }}" target="_blank" title="Share on Mastodon">Mastodon</a></li>
          <li><a class="dropdown-item" href="https://www.newspipe.org/bookmark/bookmarklet?href=https://{{ config.PUBLIC_DOMAIN }}{{ url_for('bundle_bp.get', bundle_uuid=bundle.uuid) }}&title={{ bundle.name }}" target="_blank" title="Share on Newspipe">Newspipe</a></li>
          <li><a class="dropdown-item" href="https://api.pinboard.in/v1/posts/add?url=https://{{ config.PUBLIC_DOMAIN }}{{ url_for('bundle_bp.get', bundle_uuid=bundle.uuid) }}&description=%27{{ bundle.name }}" target="_blank" title="Share on Pinboard">Pinboard</a></li>
          <li><a class="dropdown-item" href="https://reddit.com/submit?url=https://{{ config.PUBLIC_DOMAIN }}{{ url_for('bundle_bp.get', bundle_uuid=bundle.uuid) }}&title=%27{{ bundle.name }}%27" target="_blank" title="Share on Reddit">Reddit</a></li>
        </ul>
      </div>
      <a type="button" class="btn btn-primary" onclick="copyCurrentPageURL()">{{ render_icon('clipboard') }}</a>
      {% if current_user.is_authenticated and current_user.is_admin %}
      <a type="button" class="btn btn-primary" title="Edit" aria-label="Edit" href="{{ url_for('admin_bp.form_bundle', bundle_uuid=bundle.uuid) }}">{{ render_icon('pen') }}</a>
      {% endif %}
    </div>
  </div>
</div>
<p>Created on {{ bundle.creation_timestamp | datetimeformat }} and updated on {{ bundle.timestamp | datetimeformat }}.</p>
<h2>Description</h2>
<span id="markdown-description" class="markdown-description">{{ description  | safe }}</span>
<h2>Vulnerabilities included in this bundle</h2>
<ul class="list-group">
  {% for vuln in bundle.related_vulnerabilities %}
  <li class="list-group-item list-group-item-related" vuln-id="{{ vuln }}"><a href="{{ url_for('home_bp.vulnerability_view', vulnerability_id=vuln) }}">{{ vuln }}</a>: <span class="vuln-description"></span></li>
  {% endfor %}
</ul>
{% if bundle.meta %}
<h2>Meta</h2>
<pre id="jsoncontainer">{{ bundle.meta | tojson(indent=2) }}</pre>
{% endif %}
<h2>Author</h2>
<a href="{{ url_for('user_bp.profile', login=bundle.author.login) }}">{{ bundle.author.name }}</a>
<hr />
<h2>Combined sightings</h2>
<div class="table-responsive">
  <table class="table">
    <thead>
      <tr>
        <th scope="col">Author</th>
        <th scope="col">Vulnerability</th>
        <th scope="col">Source</th>
        <th scope="col">Type</th>
        <th scope="col">Date</th>
      </tr>
    </thead>
    <tbody id="sighting-table-body"></tbody>
  </table>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    jsonContainer = document.getElementById("jsoncontainer");
    if (jsonContainer) {
      jsonContainer.innerHTML = prettyPrintJson.toHtml(JSON.parse(jsonContainer.innerText));
    }
    // Post formatting
    document.getElementById("markdown-description").innerHTML = linkifySecurityIdentifiers(document.getElementById("markdown-description").innerHTML);
    formatMarkdownOutput();


    // Populate the table of combined sightings.
    const urlParts = window.location.pathname.split("/");
    const uuid = urlParts[urlParts.length - 1];
    const tableBody = document.getElementById("sighting-table-body");

    // Function to create table rows
    function addRowToTable(sighting) {
        const row = document.createElement("tr");

        const authorCell = document.createElement("td");
        authorCell.textContent = sighting.author.name;
        row.appendChild(authorCell);

        const vulnerabilityCell = document.createElement("td");
        vulnerabilityCell.innerHTML = '<a href="/vuln/'+sighting.vulnerability+'">'+sighting.vulnerability.toUpperCase()+'</a>';;
        row.appendChild(vulnerabilityCell);

        const sourceCell = document.createElement("td");
        sourceCell.textContent = sighting.source;
        row.appendChild(sourceCell);

        const typeCell = document.createElement("td");
        typeCell.textContent = sighting.type;
        row.appendChild(typeCell);

        const dateCell = document.createElement("td");
        dateCell.classList.add('datetime');
        dateCell.textContent = sighting.creation_timestamp;
        dateCell.title = sighting.creation_timestamp;
        row.appendChild(dateCell);

        tableBody.appendChild(row);
    }

    // Fetch bundle data
    fetch(`/api/bundle/?uuid=${uuid}`)
    .then(response => response.json())
    .then(bundleData => {
        const vulnerabilities = bundleData.data[0]?.related_vulnerabilities || [];

        // Fetch sightings for each vulnerability
        vulnerabilities.forEach(vuln_id => {
            fetch(`/api/sighting/?vuln_id=${vuln_id}`)
                .then(response => response.json())
                .then(sightingData => {
                    // Sort sightings by vulnerability ID
                    sightingData.data.sort((a, b) => a.vulnerability.toLowerCase().localeCompare(b.vulnerability.toLowerCase()));

                    // Add each sighting as a row in the table
                    sightingData.data.forEach(sighting => addRowToTable(sighting));
                })
                .then(_ => {
                    var DateTime = luxon.DateTime;
                    elements = document.getElementsByClassName("datetime");
                    Array.prototype.forEach.call(elements, function(element) {
                      element.textContent = DateTime.fromISO(element.title).toRelative();

                    });
                })
                .catch(error => console.error("Error fetching sighting:", error));
        });
    })
    .catch(error => console.error("Error fetching bundle:", error));

    fetchAndAppendVulnerabilityTitles();
});

  function copyCurrentPageURL() {
      const currentURL = window.location.href; // Get the current page URL
      navigator.clipboard.writeText(currentURL).then(() => {
        showToast("Success", "The bundle permalink has been copied to your clipboard.");
      }).catch(err => {
        console.error('Failed to copy: ', err);
      });
  }

  async function fetchAndAppendVulnerabilityTitles() {
    // Select all list items with the class `list-group-item-related`
    const listItems = document.querySelectorAll('.list-group-item-related');

    // Iterate through each list item
    for (const listItem of listItems) {
      // Get the vulnerability ID from the `vuln-id` attribute
      const vulnId = listItem.getAttribute('vuln-id');

      try {
        // Make a GET request to fetch the vulnerability data
        const response = await fetch(`/vulnerability/${vulnId}`);
        if (!response.ok) throw new Error(`Failed to fetch data for ${vulnId}`);

        // Parse the JSON response
        const data = await response.json();

        // Retrieve the title from the response (CVE)
        let description = data?.containers?.cna?.title;
        // If description is not found, try to get the English description from descriptions
        if (!description) {
          const descriptions = data?.containers?.cna?.descriptions || [];
          const englishDescription = descriptions.find(desc => desc.lang === "en");
          description = englishDescription ? englishDescription.value : null;
        }
        // If description still not found, maybe it's GHSA security advisory
        if (!description) {
          description = data?.details || null;
        }
        // Final fallback try to find a description in a CSAF security advisory
        if (!description) {
          description = data?.document?.title || "No description available.";
        }

        if (description) {
          const span = listItem.querySelector('span')
          if (span) {
            span.textContent = truncateString(description, 120);
          } else {
            console.warn(`No span found inside list item for ${vulnId}`);
          }
        }
      } catch (error) {
        console.error(`Error fetching data for ${vulnId}:`, error);
      }
    }
  }

</script>
{% endblock %}
