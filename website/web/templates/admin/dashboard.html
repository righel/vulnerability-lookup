{% import 'admin/template_responsive_table_users.html' as users_templates with context %}
{% extends "main.html" %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/pretty-print-json.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/utils.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/pretty-print-json.css') }}" />
{% endblock %}
{% block title %}Dasboard{% endblock %}
{% block content %}
<h1>Dashboard</h1>
<div class="row">
  <div class="col-md-6">
    <h2 id="storage">Storage</h2>
    <ul class="list-group">
      <li class="list-group-item">Number of <a href="{{ url_for('admin_bp.list_users') }}">users</a>: {{ nb_users }}</li>
      <li class="list-group-item">Number of <a href="{{ url_for('admin_bp.list_comments') }}">comments</a>: {{ nb_comments }}</li>
      <li class="list-group-item">Number of <a href="{{ url_for('admin_bp.list_bundles') }}">bundles</a>: {{ nb_bundles }}</li>
      <li class="list-group-item">Number of <a href="{{ url_for('admin_bp.list_sightings') }}">sightings</a>: {{ nb_sightings }}</li>
    </ul>
    <br />
    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStorage" aria-expanded="false" aria-controls="collapseStorage">Security advisory sources</button>
    <div class="collapse" id="collapseStorage">
      <br />
      <div class="card card-body">
        <pre id="json-container">{{storage_info|tojson(indent=2)}}</pre>
      </div>
      <br />
    </div>
  </div>
  <div class="col-md-6">
    <h2 id="instance-status">Instance status</h2>
    <ul class="list-group">
      <li class="list-group-item">Two-Factor Authentication: <em>{% if config["ENFORCE_2FA"] %}Enforced{% else %}Not enforced{% endif %}</em></li>
      <li class="list-group-item">Self-registration: <em>{% if config["SELF_REGISTRATION"] %}Open{% else %}Closed{% endif %}</em></li>
      <li class="list-group-item">Comments moderation: <em>{% if config["COMMENTS_MODERATION"] %}On{% else %}Off{% endif %}</em></li>
      <li class="list-group-item">Instance UUID: <em>{{ local_instance_uuid }}</em></li>
      <li class="list-group-item">Instance name: <em>{{ local_instance_name }}</em></li>
    </ul>
  </div>
</div>
<br />
<div class="row">
  <div class="col">
    <h2 id="instance-status">Maintenance</h2>
    <button id="maintenance-warning-lists" class="btn btn-primary" type="button" title="Update the MISP Warning lists in background.">Update MISP Warning lists</button>
    <button id="maintenance-backup-database" class="btn btn-primary" type="button" title="Backup the database in background.">Backup database</button>
    <button id="maintenance-dump-feeds" class="btn btn-primary" type="button" title="Dump all feeds in background.">Dump all feeds</button>
    <button id="maintenance-dump-sightings" class="btn btn-primary" type="button" title="Dump all sightings in background.">Dump sightings</button>
  </div>
</div>
<br />
<div class="row">
  <div class="col">
    <h2 id="active-users">Active users</h2>
    <p>Users who connected during the past week.</p>
    {{ users_templates.table_users(users=users) }}
    <p>See <a href="{{ url_for('admin_bp.list_users') }}">all users</a>.</p>
  </div>
</div>
<br />
<script>
  function rpc_maintainance(url) {
    fetch(url)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json(); // or response.text() for plain text
    })
    .then(data => {
      // console.log(data["message"]);
      showToast("Success", data["message"]);
    })
    .catch(error => {
      // console.error('There has been a problem during the operation:', error);
      // alert('There has been a problem during the operation:', error);
      showToast("Error", "There has been a problem during the operation");
    });
  }

  function update_warninglists() {
    rpc_maintainance("/admin/command/update_warninglists");
  }

  function backup_database() {
    rpc_maintainance("/admin/command/backup_database");
  }

  function dump_feeds() {
    rpc_maintainance("/admin/command/dump_feeds");
  }

  function dump_sightings() {
    rpc_maintainance("/admin/command/dump_sightings");
  }

  document.addEventListener("DOMContentLoaded", function() {
    var jsonContainer = document.getElementById("json-container");
    jsonContainer.innerHTML = prettyPrintJson.toHtml(JSON.parse(jsonContainer.innerText));

    document.getElementById("maintenance-warning-lists").addEventListener('click',function (event)
    {
      showModal('Confirm', "Update the MISP warning lists in background ?", update_warninglists, event);
    })

    document.getElementById("maintenance-backup-database").addEventListener('click',function (event)
    {
      showModal('Confirm', "Dump the database in background ?", backup_database, event);
    })

    document.getElementById("maintenance-dump-feeds").addEventListener('click',function (event)
    {
      showModal('Confirm', "Dump all security advisory feeds in background ?", dump_feeds, event);
    })

    document.getElementById("maintenance-dump-sightings").addEventListener('click',function (event)
    {
      showModal('Confirm', "Dump all sightings in background ?", dump_sightings, event);
    })
  });
</script>
{% endblock %}
