{% extends "main.html" %}
{% import 'vulnerability_templates.html' as vuln_templates %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/luxon.min.js') }}"></script>
{% endblock %}
{% block title %}Recent vulnerabilities{% endblock %}
{% block content %}
<h1>Recent vulnerabilities</h1>
<ul class="nav nav-pills nav-fill" id="vulnSourcesTab" role="tablist">
  {% for source, vulns in recent.items() %}
  <li class="nav-item" role="presentation">
      <button class="nav-link {% if source == default_source %}active{%endif%}" id="{{source}}-tab"
                                      data-bs-toggle="tab"
                                      data-bs-target="#{{source}}-tab-pane"
                                      type="button" role="tab"
                                      aria-controls="{{source}}-tab-pane"
                                      aria-selected="true">
		{{sources_to_show[source]}}
	  </button>
  </li>
  {%endfor%}
</ul>
<br />
<div class="tab-content" id="vulnSourcesTabContent">
  {% for source, vulns in recent.items() if vulns %}
  <div class="tab-pane fade show {% if source == 'cvelistv5' %} active {%endif%}"
       id="{{source}}-tab-pane" role="tabpanel" aria-labelledby="{{source}}-tab" tabindex="0">
       <div class="text-end"><a class="icon-link" href="{{ url_for('home_bp.feed_recent', format='atom', source=source) }}" type="application/atom+xml" title="Atom feed">{{ render_icon('rss') }}</a>
       <a class="icon-link" href="{{ url_for('home_bp.feed_recent', format='rss', source=source) }}" type="application/atom+xml" title="RSS feed">{{ render_icon('rss-fill') }}</a></div>
  <div class="table-responsive">
    <table class="table table-striped caption-top">
      <caption>Vulnerabilities are sorted by update time (recent to old).</caption>
      <thead>
      <tr>
            {%if source in ["cvelistv5", "nvd", local_instance_name] %}
            <th scope="col" class="col-md-1">ID</th>
            <th scope="col" class="col-md-2">CVSS Base Score</th>
            <th scope="col" class="col-md-3">Description</th>
            <th scope="col" class="col-md-1">Vendor</th>
            <th scope="col" class="col-md-1">Product</th>
            <th scope="col" class="col-md-1">Publish Date</th>
            <th scope="col" class="col-md-1">Update Date</th>
            {% elif 'csaf_' in source  %}
            <th scope="col" class="col-md-1">ID</th>
            <th scope="col">Description</th>
            <th scope="col" class="col-md-1">Publish Date</th>
            <th scope="col" class="col-md-1">Update Date</th>
            {% elif source in ['jvndb', 'ossf_malicious_packages', 'pysec']  %}
            <th scope="col" class="col-md-1">ID</th>
            <th scope="col">Description</th>
            <th scope="col" class="col-md-1">Publish Date</th>
            <th scope="col" class="col-md-1">Update Date</th>
            {% else %}
            <th scope="col">ID</th>
            <th scope="col">Description</th>
            {%endif%}
      </tr>
      </thead>
      <tbody>
      {%for vuln_id, vuln in vulns %}
          {% if source in ["cvelistv5", "nvd", local_instance_name] %}
          <tr>
            <th scope="row">
              <a href="{{url_for('home_bp.vulnerability_view', vulnerability_id=vuln_id)}}">{{vuln_id}}</a>
              {% if source in ["cvelistv5", "nvd"] %}(<a href="https://nvd.nist.gov/vuln/detail/{{vuln_id}}">NVD</a>){% endif %}
            </th>
            <td>
            {%if 'metrics' in vuln['containers']['cna'] %}
              {% for metric in vuln['containers']['cna']['metrics'] %}
                {% if 'format' in metric and metric['format'] == 'CVSS'%}
                  {% for k, v in metric.items() %}
                    {% if k.lower().startswith('cvss') %}
                      CVSS-v{{v['version']}}: {{v['baseScore']}}
                    {%endif%}
                  {%endfor%}
                {%endif%}
              {% endfor %}
            {% else %}
              N/A
            {%endif%}
            </td>
            <td>
              {% if vuln['containers']['cna']['title'] %}
                {{vuln['containers']['cna']['title']}}
              {% elif vuln['containers']['cna']['descriptions'] %}
                {{vuln['containers']['cna']['descriptions'][0]['value']}}
              {% else %}
                {{vuln['containers']['cna']}}
              {%endif%}
            </td>
            <td>
            {% if 'affected' in vuln['containers']['cna'] %}
              {%for affected in vuln['containers']['cna']['affected']%}
                {{affected['vendor']}}<br />
              {%endfor%}
            {% else %}
              N/A
            {%endif%}
            </td>
            <td>
            {% if 'affected' in vuln['containers']['cna'] %}
              {%for affected in vuln['containers']['cna']['affected']%}
                {{affected['product']}}<br />
              {%endfor%}
            {% else %}
              N/A
            {%endif%}
            </td>
            <td class="datetime" title="{{vuln['cveMetadata']['datePublished']}}">{{vuln['cveMetadata']['datePublished']}}</td>
            <td class="datetime" title="{{vuln['cveMetadata']['dateUpdated']}}">{{vuln['cveMetadata']['dateUpdated']}}</td>
          </tr>
          {%elif source == "github" %}
          <tr>
            <th scope="row">
                  <a href="{{url_for('home_bp.vulnerability_view', vulnerability_id=vuln_id)}}">{{vuln_id}}</a>
            (<a href="https://github.com/advisories/{{vuln_id}}">github</a>)
            </th>
            <td>{{ vuln['details'] }}</td>
          </tr>
          {% elif source == "pysec" %}
          <tr>
            <th scope="row">
                <a href="{{url_for('home_bp.vulnerability_view', vulnerability_id=vuln_id)}}">{{vuln_id}}</a>
            </th>
            <td>{{ vuln['details'] | truncate(120, True, end='...') }}</td>
            <td class="datetime" title="{{ vuln['published'] }}">{{ vuln['published'] }}</td>
            <td class="datetime" title="{{ vuln['modified'] }}">{{ vuln['modified'] }}</td>
          </tr>
          {% elif source == "ossf_malicious_packages" %}
          <tr>
            <th scope="row">
                <a href="{{url_for('home_bp.vulnerability_view', vulnerability_id=vuln_id)}}">{{vuln_id}}</a>
            </th>
            <td>{{ vuln['summary'] }}</td>
            <td class="datetime" title="{{ vuln['published'] }}">{{ vuln['published'] }}</td>
            <td class="datetime" title="{{ vuln['modified'] }}">{{ vuln['modified'] }}</td>
          </tr>
          {% elif 'csaf_' in source %}
          <tr>
            <th scope="row">
                <a href="{{url_for('home_bp.vulnerability_view', vulnerability_id=vuln_id)}}">{{vuln_id}}</a>
            </th>
            <td>
              {% if 'document' in vuln %}
                {{ vuln['document']['title'] }}
              {% else %}
                {{ vuln['document']['title']}}
              {% endif %}
            </td>
            <td class="datetime" title="{{ vuln['document']['tracking']['initial_release_date'] }}">{{ vuln['document']['tracking']['initial_release_date'] }}</td>
            <td class="datetime" title="{{ vuln['document']['tracking']['current_release_date'] }}">{{ vuln['document']['tracking']['current_release_date'] }}</td>
          </tr>
          {% elif source == "csaf_nozominetworks" %}
          <tr>
            <th scope="row">
                <a href="{{url_for('home_bp.vulnerability_view', vulnerability_id=vuln_id)}}">{{vuln_id}}</a>
            </th>
            <td>{{ vuln['document']['title'] }}</td>
          </tr>
          {% elif source == "gsd" %}
          <tr>
            <th scope="row">
              <a href="{{url_for('home_bp.vulnerability_view', vulnerability_id=vuln_id)}}">{{vuln_id}}</a>
            </th>
            <td>The format of the source doesn't require a description, click on the link for more details</td>
          </tr>
          {% elif source == "variot" %}
          <tr>
            <th scope="row">
                <a href="{{url_for('home_bp.vulnerability_view', vulnerability_id=vuln_id)}}">{{vuln_id}}</a>
            </th>
            <td>{%if 'description' in vuln %}{{vuln['description']['data']}}{% endif %}</td>
          </tr>
          {% elif source == "jvndb" %}
          <tr>
            <th scope="row">
                <a href="{{url_for('home_bp.vulnerability_view', vulnerability_id=vuln_id)}}">{{vuln_id}}</a>
            </th>
            <td>{%if 'title' in vuln %}{{vuln['title']}}{% endif %}</td>
            <td class="datetime" title="{{ vuln['dcterms:issued'] }}">{{ vuln['dcterms:issued'] }}</td>
            <td class="datetime" title="{{ vuln['dcterms:modified'] }}">{{ vuln['dcterms:modified'] }}</td>
          </tr>
          {% elif source == "tailscale" %}
          <tr>
            <th scope="row">
                <a href="{{url_for('home_bp.vulnerability_view', vulnerability_id=vuln_id)}}">{{vuln_id}}</a>
            </th>
            <td>{%if 'title' in vuln %}{{vuln['title']}}{% endif %}</td>
          </tr>
      {% else %}
      <tr>
        <td colspan="1">
        <pre>{{ vuln | tojson(indent=2) }}</pre>
        </td>
      </tr>
      {% endif %}
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>
  {% endfor %}
</div>
<nav aria-label="Navigate vulnerabilities">
  <ul class="pagination justify-content-center">
    <li class="page-item">
        <a class="page-link {%if current_page <= 1 %} disabled {%endif%}"
           href="{{url_for('home_bp.recent', page=current_page-1)}}"
          aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
      </a>
    </li>
    <li class="page-item">
      <a class="page-link {%if current_page == 1%}active{%endif%}" href="{{url_for('home_bp.recent', page=1 if current_page == 1 else current_page - 1)}}">
        {% if current_page > 1%}
            {{current_page - 1}}
        {%else%}
            1
        {%endif%}
      </a>
    </li>
    <li class="page-item">
      <a class="page-link {%if current_page > 1%}active{%endif%}" href="{{url_for('home_bp.recent', page=2 if current_page == 1 else current_page)}}">
        {% if current_page > 1%}
            {{current_page}}
        {%else%}
            2
        {%endif%}
      </a>
    </li>
    <li class="page-item">
      <a class="page-link" href="{{url_for('home_bp.recent', page=3 if current_page == 1 else current_page + 1)}}">
        {% if current_page > 1%}
            {{current_page + 1}}
        {%else%}
            3
        {%endif%}
      </a>
    </li>
    <li class="page-item">
      <a class="page-link" href="{{url_for('home_bp.recent', page=current_page+1)}}" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
      </a>
    </li>
  </ul>
</nav>
<br />
{% endblock %}
{% block scripts %}
{{ super() }}
<script type="text/javascript">
  var tabs = document.querySelectorAll('button[data-bs-toggle="tab"]')
  tabs.forEach(tab =>  {
      tab.addEventListener('click', (event) => {
          localStorage.setItem('lastTab', event.target.getAttribute('id'));
      });
  })
  var lastTab = localStorage.getItem('lastTab');
  if (lastTab) {
    var t = document.getElementById(lastTab);
    var tab = new bootstrap.Tab(t)
    tab.show()
  }

  var DateTime = luxon.DateTime;
  elements = document.getElementsByClassName("datetime");
  Array.prototype.forEach.call(elements, function(element) {
    element.textContent = DateTime.fromISO(element.textContent).toRelative()
  });
</script>
{% endblock %}
