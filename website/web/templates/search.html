{% extends "main.html" %}
{% import 'vulnerability_templates.html' as vuln_templates with context %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/pretty-print-json.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/pretty-print-json.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/choices.min.css') }}" />
<script src="{{ url_for('static', filename='js/lodash.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/choices.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/plots.js') }}"></script>
<style>
  .top-right-card {
    max-width: 500px;
    min-height: 100px;
    padding-bottom: 40px;
  }

  .small-list-group-item {
    padding: 5px 5px; /* Adjust the padding to reduce height */
  }

  /* Style to make the chart scrollable horizontally */
  .chart-container {
    position: relative; /* Required for positioning */
    width: 100%; /* Make it responsive */
    height: 300; /* Set a specific height for the chart */
  }
  .chart-container-seen {
    position: relative; /* Required for positioning */
    width: 95%; /* Make it responsive */
    height: 300px; /* Set a specific height for the chart */
  }
  canvas {
    width: 100% !important; /* Make the canvas take full width */
    height: 100% !important; /* Allow the height to adjust automatically */
  }
</style>
{% endblock %}
{% block title %}Vulnerability-Lookup{% if vulnerability_id or vendor %} - Search a vulnerability{% endif %}{% endblock %}
{% block content %}

<div class="d-flex flex-column">

  {% if not vulnerability_id and not vendor and config.user_accounts %}
  <div class="container-fluid">
    <div class="row pt-5 d-flex justify-content-end">
      <div class="col-md text-center">
        <div id="sightingsChartContainerSeen" class="chart-container-seen">
          <canvas id="exploitedVulnsChartSeen" height="300"></canvas>
        </div>
      </div>
      <div id="commentsContainer" class="col-md top-right-card">
        <div class="card">
          <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" id="comments-tab" data-bs-toggle="tab" href="#comments" role="tab" aria-controls="home" aria-selected="true">Comments</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="bundles-tab" data-bs-toggle="tab" href="#bundles" role="tab" aria-controls="bundles" aria-selected="false">Bundles</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="sightinhs-tab" href="/sightings" aria-controls="sightings" aria-selected="false">Sightings</a>
              </li>
            </ul>
          </div>
          <div class="card-body">
            <div class="tab-content" id="myTabContent">
              <div class="tab-pane fade show active" id="comments" role="tabpanel" aria-labelledby="comments-tab">
                <ul id="list-comments" class="list-group list-group-flush"></ul>
              </div>
              <div class="tab-pane fade" id="bundles" role="tabpanel" aria-labelledby="bundles-tab">
                <ul id="list-bundles" class="list-group list-group-flush"></ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {% if not vulnerability_id and not vendor %}
  <div class="container-fluid pt-5">
    <div class="row justify-content-between">
        <div class="col-md text-start">
          <div id="sightingsChartContainerExploited" class="chart-container">
            <canvas id="exploitedVulnsChartExploited" height="300"></canvas>
          </div>
        </div>
        <div class="col-md text-end">
          <div id="sightingsChartContainerConfirmed" class="chart-container">
            <canvas id="exploitedVulnsChartConfirmed" height="300"></canvas>
          </div>
        </div>
    </div>
  </div>
  {% endif %}

  {% if source %}
    {% if source ==  'nvd' %}
    {{vuln_templates.nvd_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'cvelistv5' %}
    {{vuln_templates.cvelistv5_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'github' %}
    {{vuln_templates.github_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'gsd' %}
    {{vuln_templates.gsd_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'pysec' %}
    {{vuln_templates.pysec_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'ossf_malicious_packages' %}
    {{vuln_templates.ossf_malicious_packages_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'csaf_certbund' %}
    {{vuln_templates.csaf_certbund_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'csaf_ncscnl' %}
    {{vuln_templates.csaf_ncscnl_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'csaf_siemens' %}
    {{vuln_templates.csaf_siemens_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'csaf_redhat' %}
    {{vuln_templates.csaf_redhat_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'csaf_cisa' %}
    {{vuln_templates.csaf_cisa_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'csaf_cisco' %}
    {{vuln_templates.csaf_cisco_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'csaf_sick' %}
    {{vuln_templates.csaf_sick_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'csaf_ox' %}
    {{vuln_templates.csaf_ox_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'csaf_nozominetworks' %}
    {{vuln_templates.csaf_nozominetworks_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'variot' %}
    {{vuln_templates.variot_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'jvndb' %}
    {{vuln_templates.jvndb_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'tailscale' %}
    {{vuln_templates.tailscale_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
    {%elif source %}
    Other source: {{source}}.
    <pre class="json-container">{{ vulnerability_data|tojson(indent=2) }}</pre>
    {% endif %}
  {% endif %}

  {% if linked_vulns %}
    <h5>Vulnerabilites related to the one you searched</h5>
    {% for source, vulnerabilities in linked_vulns.items() %}
      {% for vuln_id, vulnerability_data in vulnerabilities %}
        {% if source ==  'nvd' %}
        {{vuln_templates.nvd_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'cvelistv5' %}
        {{vuln_templates.cvelistv5_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'github' %}
        {{vuln_templates.github_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'gsd' %}
        {{vuln_templates.gsd_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'ossf_malicious_packages' %}
        {{vuln_templates.ossf_malicious_packages_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_certbund' %}
        {{vuln_templates.csaf_certbund_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_ncscnl' %}
        {{vuln_templates.csaf_ncscnl_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_siemens' %}
        {{vuln_templates.csaf_siemens_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_redhat' %}
        {{vuln_templates.csaf_redhat_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_cisa' %}
        {{vuln_templates.csaf_cisa_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_cisco' %}
        {{vuln_templates.csaf_cisco_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_sick' %}
        {{vuln_templates.csaf_sick_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_ox' %}
        {{vuln_templates.csaf_ox_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_nozominetworks' %}
        {{vuln_templates.csaf_nozominetworks_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'variot' %}
        {{vuln_templates.variot_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'jvndb' %}
        {{vuln_templates.jvndb_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'tailscale' %}
        {{vuln_templates.tailscale_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {%elif source %}
        Other source: {{source}}.
        <pre>{{vulnerability_data|tojson(indent=2)}}</pre>
        {% endif %}
      {% endfor%}
    {% endfor%}
  {% endif %}

  {%if vendor %}
  <div class="position-relative top-0 start-50 translate-middle-x">
    <h1>
      {% if not vp_vulnerabilities %}
      Found {{ vendor_products | count }} product{% if vendor_products | count > 1 %}s{% endif %}
      and {{ vendor_vulns | count }} vulnerabilit{% if vendor_products | count > 1 %}ies{% else %}y{% endif %} for <i>{{ vendor }}</i>
      {% endif %}
    </h1>
    <br />
  </div>
  <form class="row g-3" role="form" method="get" action="/search" enctype="multipart/form-data">
    <input type="text" class="form-control" id="vendor" name="vendor" value="{{vendor}}" hidden>

    <div class="row">
      <div class="col">
        <label for="productsList" class="form-label">Refine search by products</label>
        <select class="form-select form-select-md" id="productsList" name="product" aria-label="Select a product.">
          <option></option>
          {% for product in vendor_products %}
          <option value="{{product}}">{{ product | truncate(70, True, end='…') }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col">
        <label for="vulnsList" class="form-label">Refine search by vulnerabilites</label>
        <select class="form-select form-select-md" id="vulnsList" name="vendor_vuln" aria-label="Select a vulnerability.">
          <option></option>
          {% for vuln in vendor_vulns %}
          <option value="{{vuln}}">{{vuln | truncate(70, True, end='…')}}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary mb-3">Search</button>
    </div>
  </form>
  {% if vp_vulnerabilities %}
    <h5>All the vulnerabilites related to {{vendor}} - {{product}}</h5>
    {% for source, vulnerabilities in vp_vulnerabilities.items() %}
      {% for vuln_id, vulnerability_data in vulnerabilities %}
        {% if source ==  'nvd' %}
        {{vuln_templates.nvd_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'cvelistv5' %}
        {{vuln_templates.cvelistv5_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'github' %}
        {{vuln_templates.github_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'gsd' %}
        {{vuln_templates.gsd_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'variot' %}
        {{vuln_templates.variot_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'jvndb' %}
        {{vuln_templates.jvndb_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'tailscale' %}
        {{vuln_templates.tailscale_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {%elif source %}
        Other source: {{source}}.
        <pre>{{ vulnerability_data|tojson(indent=2) }}</pre>
        {% endif %}
        <br />
      {% endfor %}
    {% endfor %}
  {% endif %}
  {% endif %}
</div>
{% if config.user_accounts  %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    loadSightings();
    loadComments();
    loadBundles();

    var jsonContainers = document.querySelectorAll(".json-container");
    Array.prototype.forEach.call(jsonContainers, function(jsonContainer) {
      jsonContainer.innerHTML = prettyPrintJson.toHtml(JSON.parse(jsonContainer.innerText));
    });

    document.getElementById("freetext_search").oninput = function(event) {
      var text = document.getElementById("freetext_search").value;
      if (text.length >= 3) {
        fetch("{{ url_for('apiv1.browse_vendors') }}?vendor="+text)
      .then(response => response.json())
      .then(vendors => {
        var options = '';
        vendors.map(function(vendor){
          options += '<option value="'+ vendor +'" >';
        })
        document.getElementById('vendors_list').innerHTML = options;
      });
      }
    }

    const element_product = document.getElementById("productsList");
    const choice_product = new Choices(element_product, {
      shouldSort: true,
    });
    const element_vuln = document.getElementById("vulnsList");
    const choice_vuln = new Choices(element_vuln, {
      shouldSort: true,
    });
  });

  function getDateSinceToday(daysAgo) {
    const today = new Date();
    // Subtract the given number of days
    today.setDate(today.getDate() - daysAgo);

    // Format the date as YYYY-MM-DD
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-based
    const day = String(today.getDate()).padStart(2, '0');

    return `${year}-${month}-${day}`;
  }

  function loadSightings() {
    fetch("{{ url_for('apiv1.sighting_sightings_list', type='seen') }}&date_from="+getDateSinceToday(7))
    .then(response => response.json())
    .then(result => {
      if (result.metadata.count == 0) {
          document.getElementById("sightingsChartContainerSeen").style.display = 'none';
      } else {
        document.getElementById("sightingsChartContainerSeen").style.display = 'block';
        drawBarChartHomePage(result.data, 'exploitedVulnsChartSeen', 'Mentions over the past week.', 'rgba(75, 192, 75, 0.2)');
      }
    })
    .catch((error) => {
      console.error('Error:', error);
    });

    fetch("{{ url_for('apiv1.sighting_sightings_list', type='exploited') }}&date_from="+getDateSinceToday(7))
    .then(response => response.json())
    .then(result => {
      if (result.metadata.count == 0) {
          document.getElementById("sightingsChartContainerExploited").style.display = 'none';
      } else {
        document.getElementById("sightingsChartContainerExploited").style.display = 'block';
        drawBarChartHomePage(result.data, 'exploitedVulnsChartExploited', 'Exploitations over the past week.', 'rgba(255, 99, 132, 0.2)');
      }
    })
    .catch((error) => {
      console.error('Error:', error);
    });

    fetch("{{ url_for('apiv1.sighting_sightings_list', type='confirmed') }}&date_from="+getDateSinceToday(7))
    .then(response => response.json())
    .then(result => {
      if (result.metadata.count == 0) {
          document.getElementById("sightingsChartContainerConfirmed").style.display = 'none';
      } else {
        document.getElementById("sightingsChartContainerConfirmed").style.display = 'block';
        drawBarChartHomePage(result.data, 'exploitedVulnsChartConfirmed', 'Confirmations over the past week.', 'rgba(75, 192, 192, 0.2)');
      }
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  };

  function loadComments() {
    fetch("{{ url_for('apiv1.comment_comments_list', per_page=5) }}")
    .then(response => response.json())
    .then(result => {
      if (result.metadata.count == 0) {

      } else {
        result.data
        .sort(function (a, b) {
            return new Date(b.updated_at) - new Date(a.updated_at);
        })
        .map(function (comment) {
          var element = document.createElement("li");
          element.setAttribute("class", "list-group-item small-list-group-item");
          element.innerHTML = '<a href="/user/'+comment.author.login+'">' + comment.author.login +
          '</a> commented on <a href="/comment/'+comment.uuid+'">'+comment.vulnerability+'</a>';
          document.getElementById("list-comments").appendChild(element);
        })
      }
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  };

  function truncateString(str, maxLength) {
    if (str.length > maxLength) {
        return str.slice(0, maxLength) + "…";
    }
    return str;
  }

  function loadBundles() {
    fetch("{{ url_for('apiv1.bundle_bundles_list', per_page=5) }}")
    .then(response => response.json())
    .then(result => {
      if (result.metadata.count == 0) {

      } else {
        result.data
        .sort(function (a, b) {
            return new Date(b.updated_at) - new Date(a.updated_at);
        })
        .map(function (bundle) {
          var element = document.createElement("li");
          element.setAttribute("class", "list-group-item small-list-group-item");
          element.innerHTML = '<a href="/user/'+bundle.author.login+'">' + bundle.author.login +
          '</a> created <a href="/bundle/'+bundle.uuid+'">' + truncateString(bundle.name, 25) +'</a>';
          document.getElementById("list-bundles").appendChild(element);
        })
      }
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  };
</script>
{% endif %}
{% endblock %}
