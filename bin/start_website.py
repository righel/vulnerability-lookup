#!/usr/bin/env python3

from __future__ import annotations

import logging

import logging.config
from subprocess import Popen

from vulnerabilitylookup.default import AbstractManager
from vulnerabilitylookup.default import get_config, get_homedir

logging.config.dictConfig(get_config('logging'))


class Website(AbstractManager):

    def __init__(self, loglevel: int | None=None) -> None:
        super().__init__(loglevel)
        self.script_name = 'website'
        self.process = self._launch_website()
        self.set_running()

    def _launch_website(self) -> Popen:  # type: ignore[type-arg]
        website_dir = get_homedir() / 'website'
        ip = get_config('generic', 'website_listen_ip')
        port = get_config('generic', 'website_listen_port')
        return Popen(['gunicorn', '-w', '49',
                      '--worker-class', 'gevent',
                      '--graceful-timeout', '2',
                      '--timeout', '300',
                      '-b', f'{ip}:{port}',
                      '--log-level', 'info',
                      '--reuse-port',
                      'app'],
                     cwd=website_dir)


def main() -> None:
    w = Website()
    w.run(sleep_in_sec=10)


if __name__ == '__main__':
    main()
